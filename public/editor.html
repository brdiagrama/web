<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>BrDiagrama - Gerador de Diagramas</title>
    <style>
        :root {
            --editor-bg: #282c34;
            --viewer-bg: #fdfdfd;
            --text-color: #abb2bf;
            --border-color: #444;
            --table-bg: #ffffff;
            --table-header-bg: #f0f4f8;
            --table-border: #dfe6f0;
            --pk-color: #c792ea;
            --fk-color: #89ddff;
            --line-color: #5c6773;
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: var(--editor-bg);
        }

        #container {
            display: flex;
            height: 100%;
        }

        #editor {
            width: 40%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #editor h1 {
            color: #fff;
            padding: 10px 20px;
            margin: 0;
            font-size: 1.2em;
            background-color: #1e2228;
        }
        
        #sql-input {
            flex-grow: 1;
            background-color: var(--editor-bg);
            color: var(--text-color);
            border: none;
            padding: 20px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 16px;
            line-height: 1.5;
            resize: none;
        }

        #sql-input:focus {
            outline: none;
        }

        #viewer {
            width: 60%;
            height: 100%;
            background-color: var(--viewer-bg);
            border-left: 2px solid var(--border-color);
        }

        #diagram-canvas {
            width: 100%;
            height: 100%;
        }

        /* SVG Styles */
        .table-group {
            cursor: move;
        }

        .table-rect {
            fill: var(--table-bg);
            stroke: var(--table-border);
            stroke-width: 1.5px;
            rx: 5;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .table-header {
            font-weight: bold;
            font-size: 14px;
            fill: #333;
        }
        
        .table-header-rect {
            fill: var(--table-header-bg);
        }

        .column-text {
            font-size: 13px;
            fill: #444;
        }
        
        .column-pk {
            fill: var(--pk-color);
            font-weight: bold;
        }

        .column-fk {
            fill: var(--fk-color);
            font-style: italic;
        }

        .relationship-line {
            stroke: var(--line-color);
            stroke-width: 2px;
            fill: none;
            marker-end: url(#arrowhead);
        }
    </style>
</head>
<body>

<div id="container">
    <div id="editor">
        <h1>Texto <area shape="" coords="" href="" alt=""></h1>
        <textarea id="sql-input" placeholder="Digite seu c√≥digo CREATE TABLE aqui..."></textarea>
    </div>
    <div id="viewer">
        <svg id="diagram-canvas"></svg>
    </div>
</div>

<script>
   // Inicializa√ß√£o
    const textarea = document.getElementById('sql-input');
    const svg = document.getElementById('diagram-canvas');

    const state = {
        tables: {},
        relationships: [],
        dragging: null,
        offset: { x: 0, y: 0 }
    };

    // Fun√ß√£o debounce
    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Fun√ß√£o de renderiza√ß√£o
    function render() {
        svg.innerHTML = '';
        
        svg.innerHTML = `
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${getComputedStyle(document.documentElement).getPropertyValue('--line-color')}" />
                </marker>
            </defs>
        `;

        const linesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        const tablesGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        svg.appendChild(linesGroup);
        svg.appendChild(tablesGroup);

        state.relationships.forEach(rel => {
            const fromTable = state.tables[rel.fromTable];
            const toTable = state.tables[rel.toTable];
            if (!fromTable || !toTable) return;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');

            const d = calculatePath(fromTable, toTable);
            line.setAttribute('d', d);
            line.classList.add('relationship-line');
            linesGroup.appendChild(line);
        });
        
        Object.values(state.tables).forEach(table => {
            const tableWidth = 200;
            const headerHeight = 30;
            const rowHeight = 22;
            const tableHeight = headerHeight + table.columns.length * rowHeight + 10;
            
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.classList.add('table-group');
            
            group.setAttribute('transform', `translate(${table.x}, ${table.y})`);
            group.dataset.tableName = table.name;

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', tableWidth);
            rect.setAttribute('height', tableHeight);
            rect.classList.add('table-rect');
            
            const headerRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            headerRect.setAttribute('width', tableWidth);
            headerRect.setAttribute('height', headerHeight);
            headerRect.setAttribute('rx', 5);
            headerRect.classList.add('table-header-rect');

            const headerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            headerText.setAttribute('x', 15);
            headerText.setAttribute('y', 20);
            headerText.classList.add('table-header');
            headerText.textContent = table.name;

            group.appendChild(rect);
            group.appendChild(headerRect);
            group.appendChild(headerText);
            
            table.columns.forEach((col, i) => {
                const colText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                colText.setAttribute('x', 15);
                colText.setAttribute('y', headerHeight + 20 + i * rowHeight);
                colText.classList.add('column-text');
                
                let content = `${col.name} (${col.type})`;
                if(col.isPk) {
                   colText.classList.add('column-pk');
                   content = 'üîë ' + content;
                }
                if(col.isFk) {
                   colText.classList.add('column-fk');
                   content = 'üîó ' + content;
                }
                colText.textContent = content;
                group.appendChild(colText);
            });
            
            tablesGroup.appendChild(group);
        });
    }
    
    function calculatePath(from, to) {
        const [x1, y1] = [from.x + 100, from.y + 50];
        const [x2, y2] = [to.x + 100, to.y + 50];
        return `M ${x1} ${y1} C ${x1 + 100} ${y1}, ${x2 - 100} ${y2}, ${x2} ${y2}`;
    }

    // Comunica√ß√£o com a API de back-end
    async function updateDiagram() {
        const sql = textarea.value;
        
        try {
            // 1. Chamar a API
            const response = await fetch('/api/parse', { // A URL da API
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ sql: sql }), // Envia o SQL no corpo
            });

            if (!response.ok) {
                throw new Error('Erro na resposta da API');
            }

            // Receber o JSON do back-end
            const { tables, relationships } = await response.json();
            
            // Atualizar o estado local
            const newTablesState = {};
            for (const tableName in tables) {
                const oldTable = state.tables[tableName];
                newTablesState[tableName] = {
                    ...tables[tableName],
                    x: oldTable?.x || tables[tableName].x, // Mant√©m X antigo se existir
                    y: oldTable?.y || tables[tableName].y, // Mant√©m Y antigo se existir
                };
            }
            
            state.tables = newTablesState;
            state.relationships = relationships;
            
            render();

        } catch (error) {
            console.error("Erro ao chamar API de parse:", error);
        }
    }
    
    // L√≥gica de Drag-and-Drop
    svg.addEventListener('mousedown', (e) => {
        const group = e.target.closest('.table-group');
        if (group) {
            state.dragging = group;
            const ctm = svg.getScreenCTM();
            const transform = group.transform.baseVal.getItem(0);
            state.offset.x = (e.clientX - ctm.e) / ctm.a - transform.matrix.e;
            state.offset.y = (e.clientY - ctm.f) / ctm.d - transform.matrix.f;
        }
    });

    svg.addEventListener('mousemove', (e) => {
        if (state.dragging) {
            e.preventDefault();
            const ctm = svg.getScreenCTM();
            const x = (e.clientX - ctm.e) / ctm.a - state.offset.x;
            const y = (e.clientY - ctm.f) / ctm.d - state.offset.y;
            
            state.dragging.setAttribute('transform', `translate(${x}, ${y})`);
            
            const tableName = state.dragging.dataset.tableName;
            state.tables[tableName].x = x;
            state.tables[tableName].y = y;
            
            const linesGroup = svg.querySelector('g:first-of-type');
            if (linesGroup) {
                linesGroup.innerHTML = '';
                state.relationships.forEach(rel => {
                    const fromTable = state.tables[rel.fromTable];
                    const toTable = state.tables[rel.toTable];
                    if (!fromTable || !toTable) return;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = calculatePath(fromTable, toTable);
                    line.setAttribute('d', d);
                    line.classList.add('relationship-line');
                    linesGroup.appendChild(line);
                });
            }
        }
    });

    svg.addEventListener('mouseup', () => {
        state.dragging = null;
    });

    // Event listener e chamada inicial
    textarea.addEventListener('input', debounce(updateDiagram, 500));
    
    // Exemplo inicial
    textarea.value = `CREATE TABLE usuarios (
    id INT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE
);

CREATE TABLE posts (
    id INT PRIMARY KEY,
    titulo VARCHAR(255) NOT NULL,
    conteudo TEXT,
    usuario_id INT,
    CONSTRAINT fk_usuario
        FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);
`;
    updateDiagram(); // Chama a fun√ß√£o que agora usa a API
</script>
</body>
</html>